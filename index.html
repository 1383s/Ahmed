<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AHMED || Full Mark</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js';
        import { getDatabase, ref, onValue, update, remove, set, get } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js'; 

        const firebaseConfig = {
            apiKey: "AIzaSyBK6FZF3LW83qaUHBKYTfiVd2Ozrd1Rf2g",
            authDomain: "thanawy-1383.firebaseapp.com",
            databaseURL: "https://thanawy-1383-default-rtdb.firebaseio.com",
            projectId: "thanawy-1383",
            storageBucket: "thanawy-1383.firebasestorage.app",
            messagingSenderId: "1026664406457",
            appId: "1:1026664406457:web:87d71f7e41bef36ba0aa68",
            measurementId: "G-J5R2EFM2D0"
        };
        
        const CURRENT_ADMIN_ROLE = 'ahmed'; 
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const codesRef = ref(db, 'approvedStudents');
        const blockedDevicesRef = ref(db, 'blockedDevices'); 
        
        let allApprovedCodes = {}; 
        let currentUserUid = null;
        const AHMED_FIXED_UID = "4Mr7j0R3GmNrpxeaOWKzv71oHpY2"; 
        let allSaraCodes = [];
        let currentReportCodes = [];
        let allBlockedDevices = []; 

        const DIVISIONS = ['Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…', 'Ø£Ø¯Ø¨ÙŠ', 'Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©', 'Ø£Ø²Ù‡Ø±']; 
        
        // ğŸ’¡ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù€ Bulk Actions
        let selectedUids = new Set(); 

        window.showToast = (message, type = "success") => { 
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '1'; toast.style.transform = 'translateY(0)'; }, 10);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        };
        
        // ğŸ’¡ Logic 1 & 2: checkAdminStatus & checkAuthAndProceed (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
        async function checkAdminStatus(uid) {
            if (uid === AHMED_FIXED_UID) { 
                return true;
            } else {
                window.showToast("âŒ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ù‡ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ahmed.", "error");
                return false;
            }
        }
        
        async function checkAuthAndProceed(action, ...args) {
            if (!currentUserUid) {
                window.showToast("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§ Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ©.", "error");
                return;
            }
            if (await checkAdminStatus(currentUserUid)) { 
                action(...args);
            }
        }

        // ğŸ’¡ Logic 3, 4, 5: Login, Logout, generateUniqueCode (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                window.showToast("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...", "success");
            } catch (error) {
                window.showToast(`âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${error.message}`, "error");
            }
        };

        window.logout = async () => {
            await signOut(auth);
            window.showToast("ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­.", "warn");
            window.location.reload(); 
        };

        function generateUniqueCode() {
            let code;
            do {
                code = String(Math.floor(100000 + Math.random() * 900000));
            } while (allApprovedCodes[code]); 
            return code;
        }

        // ğŸ’¡ Logic 6: Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ
        window.ejectDevice = (uid, name) => checkAuthAndProceed(() => {
            if (!confirm(`Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®Ø±Ø§Ø¬ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ${name} (${uid}) Ù…Ù† Ø¬Ù‡Ø§Ø²Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠØŸ`)) return;
            update(ref(db, 'approvedStudents/' + uid), {
                deviceId: "",
            }).then(() => {
                window.showToast(`âœ… ØªÙ… Ø¥Ø®Ø±Ø§Ø¬ ÙƒÙˆØ¯ ${uid} Ø¨Ù†Ø¬Ø§Ø­.`, "success");
            }).catch(e => window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬: " + e.message, "error"));
        });
        
        // ğŸ’¡ Logic 7: Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø²
        window.copyDeviceId = (deviceId) => {
            if (!deviceId) {
                window.showToast("âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙÙØ¹Ù„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø­Ø§Ù„ÙŠÙ‹Ø§.", "warn");
                return;
            }
            navigator.clipboard.writeText(deviceId)
                .then(() => window.showToast(`âœ… ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø²: ${deviceId}`, "success"))
                .catch(err => window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®.", "error"));
        };

        // ğŸ’¡ Logic 8: Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯
        window.deleteCode = (uid, name) => checkAuthAndProceed(() => {
            if (!confirm(`Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ${name} (${uid}) Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`)) return;
            remove(ref(db, 'approvedStudents/' + uid))
            .then(() => window.showToast(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ ${uid} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`, "success"))
            .catch(e => window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + e.message, "error"));
        });
        
        // ğŸ’¡ Logic 9: ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        window.toggleBlock = (uid, name, isBlocked) => checkAuthAndProceed(() => {
            update(ref(db, 'approvedStudents/' + uid), {
                isBlocked: !isBlocked
            }).then(() => {
                window.showToast(`âœ… ØªÙ… ${!isBlocked ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'} ÙƒÙˆØ¯ ${name} Ø¨Ù†Ø¬Ø§Ø­.`, "success");
            }).catch(e => window.showToast("âŒ ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©: " + e.message, "error"));
        });

        // ğŸ’¡ Logic 10: Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ Ø§Ù„Ø´Ø¹Ø¨Ø©ØŒ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©ØŒ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ù‚ØµÙ‰)
        window.addNewCode = (e) => checkAuthAndProceed(() => {
            e.preventDefault();
            const form = e.target;
            const name = form.studentName.value;
            const section = form.studentSection.value; 
            const price = parseFloat(form.price.value) || 0;
            const durationType = form.durationType.value;
            const newCode = document.getElementById('newCodeDisplay').textContent;
            
            if (!section) {
                window.showToast("âŒ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø¹Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨.", "error");
                return;
            }

            let expiryTime = Date.now();
            
            if (durationType === 'trial') {
                expiryTime += 1 * 60 * 60 * 1000;
            } else if (durationType === '30days') {
                expiryTime += 30 * 24 * 60 * 60 * 1000;
            } else {
                window.showToast("âŒ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ø³Ø§Ø¹Ø© Ø£Ùˆ 30 ÙŠÙˆÙ…).", "error");
                return;
            }

            set(ref(db, 'approvedStudents/' + newCode), {
                uid: newCode,
                name: name,
                section: section, 
                pricePaid: price,
                addedByAdmin: CURRENT_ADMIN_ROLE,
                approvedAt: Date.now(),
                expiry: expiryTime,
                deviceId: "",
                isBlocked: false,
                isTrial: durationType === 'trial',
                deviceChangeCount: 0, // ğŸ’¡ Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                maxDeviceChanges: 5,   // ğŸ’¡ Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 5)
                deviceHistory: []      // ğŸ’¡ Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            }).then(() => {
                window.showToast(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ¯ ${newCode} Ø¨Ù†Ø¬Ø§Ø­. Ø§Ù„Ø´Ø¹Ø¨Ø©: ${section}`, "success");
                window.toggleAddCodeForm(false);
                form.reset();
            }).catch(error => {
                window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: " + error.message, "error");
            });
        }, e);
        
        // ğŸ’¡ Logic 11: ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
        window.openEditModal = (uid, currentName, currentSection) => checkAuthAndProceed(() => {
            document.getElementById('edit_uid').value = uid;
            document.getElementById('edit_name').value = currentName;
            
            const sectionSelect = document.getElementById('edit_section');
            sectionSelect.innerHTML = ''; 
            DIVISIONS.forEach(div => {
                const option = document.createElement('option');
                option.value = div;
                option.textContent = div;
                if (div === currentSection) option.selected = true;
                sectionSelect.appendChild(option);
            });
            
            document.getElementById('editModal').style.display = 'flex';
        });

        // ğŸ’¡ Logic 12: Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
        window.saveEdit = () => checkAuthAndProceed(() => {
            const uid = document.getElementById('edit_uid').value;
            const newName = document.getElementById('edit_name').value;
            const newSection = document.getElementById('edit_section').value;

            update(ref(db, 'approvedStudents/' + uid), {
                name: newName,
                section: newSection
            }).then(() => {
                window.showToast(`âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ${uid} Ø¨Ù†Ø¬Ø§Ø­.`, "success");
                document.getElementById('editModal').style.display = 'none';
            }).catch(e => window.showToast("âŒ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + e.message, "error"));
        });
        
        // ğŸ’¡ Logic 13, 14, 15: Ø­Ø¸Ø±/Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø² (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
        window.blockDevice = (deviceId) => checkAuthAndProceed(() => {
            if (!deviceId || deviceId.trim() === "") {
                window.showToast("âŒ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø².", "warn");
                return;
            }
            const cleanId = deviceId.trim();

            set(ref(db, 'blockedDevices/' + cleanId), {
                deviceId: cleanId,
                blockedBy: CURRENT_ADMIN_ROLE,
                blockedAt: Date.now(),
            }).then(() => {
                window.showToast(`âœ… ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² ${cleanId} Ø¨Ù†Ø¬Ø§Ø­.`, "success");
            }).catch(e => window.showToast("âŒ ÙØ´Ù„ Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø²: " + e.message, "error"));
        });

        window.blockNewDevice = () => {
            const deviceId = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø­Ø¸Ø±Ù‡:");
            if (deviceId) {
                blockDevice(deviceId);
            }
        };

        window.unblockDevice = (deviceId) => checkAuthAndProceed(() => {
            if (!confirm(`Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² ${deviceId}ØŸ`)) return;
            remove(ref(db, 'blockedDevices/' + deviceId))
            .then(() => window.showToast(`âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² ${deviceId} Ø¨Ù†Ø¬Ø§Ø­.`, "success"))
            .catch(e => window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡: " + e.message, "error"));
        });
        
        // ğŸ’¡ Logic 16: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø²
        function isDeviceBlocked(deviceId) {
            if (!deviceId) return false;
            return allBlockedDevices.some(device => device.deviceId === deviceId);
        }

        // ğŸ’¡ Logic 17: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙˆØªØµÙ†ÙŠÙÙ‡Ø§ (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
        function loadSaraCodes() {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
            onValue(codesRef, (snapshot) => {
                allApprovedCodes = {}; 
                let activeCount = 0;
                let blockedCount = 0;
                let expiredCount = 0;
                let totalAmount = 0;
                allSaraCodes = [];
                
                const now = Date.now();
                
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    data.uid = childSnapshot.key;
                    allApprovedCodes[childSnapshot.key] = data;
                    
                    if ((data.addedByAdmin || '').toLowerCase() === CURRENT_ADMIN_ROLE) { 
                        allSaraCodes.push(data);
                        totalAmount += (data.pricePaid || 0);

                        const isBlocked = data.isBlocked === true;
                        const isExpired = data.expiry < now;

                        if (isExpired) {
                            expiredCount++;
                        } else if (isBlocked) {
                            blockedCount++;
                        } else {
                            activeCount++;
                        }
                    }
                });
                
                document.getElementById('statActiveCount').textContent = activeCount;
                document.getElementById('statBlockedCount').textContent = blockedCount;
                document.getElementById('statExpiredCount').textContent = expiredCount;
                
                renderStats(activeCount + blockedCount + expiredCount, totalAmount);
                window.showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­ØªÙƒ ÙŠØ§ Ø£Ø­Ù…Ø¯.", "success");
                
                const activeReport = document.getElementById('reportDisplayArea').getAttribute('data-active-report');
                if (activeReport) {
                    toggleReportDisplay(activeReport, true); 
                } else {
                    document.getElementById('codesTableBody').innerHTML = '<tr><td colspan="10">Ø§Ø®ØªØ± Ø¨Ø·Ø§Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„...</td></tr>';
                }
            }, (error) => {
                window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø£ÙƒÙˆØ§Ø¯): " + error.message, "error");
            });

            // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© (Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±Ø©)
            onValue(blockedDevicesRef, (snapshot) => {
                allBlockedDevices = [];
                const currentAdminRole = CURRENT_ADMIN_ROLE;
                
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    data.deviceId = childSnapshot.key;
                    
                    if ((data.blockedBy || '').toLowerCase() === currentAdminRole) {
                        allBlockedDevices.push(data);
                    }
                });
                
                if (document.getElementById('blockedDevicesArea').style.display === 'block') {
                    renderBlockedDevicesTable(allBlockedDevices);
                }
            }, (error) => {
                 window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©): " + error.message, "error");
            });
        }
        
        // ğŸ’¡ Logic 18, 19, 20, 21: (toggleReportDisplay, toggleBlockedDevicesArea, clearSearchAndTable, filterTable) - ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ

        window.toggleReportDisplay = (reportType, forceUpdate = false) => {
            document.getElementById('blockedDevicesArea').style.display = 'none';

            const displayArea = document.getElementById('reportDisplayArea');
            const currentActive = displayArea.getAttribute('data-active-report');
            const now = Date.now();
            const searchInput = document.getElementById('searchInput');

            let filteredCodes = [];
            let title = "";
            
            if (reportType === 'active') {
                title = "Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙØ¹Ù‘Ù„Ø© (Ù†Ø´Ø·Ø© ÙˆØºÙŠØ± Ù…Ù†ØªÙ‡ÙŠØ©)";
                filteredCodes = allSaraCodes.filter(c => c.isBlocked !== true && c.expiry >= now);
            } else if (reportType === 'blocked') {
                title = "Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø¹Ø·Ù‘Ù„Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§";
                filteredCodes = allSaraCodes.filter(c => c.isBlocked === true);
            } else if (reportType === 'expired') {
                title = "Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©";
                filteredCodes = allSaraCodes.filter(c => c.expiry < now);
            }
            
            currentReportCodes = filteredCodes;

            if (currentActive === reportType && !forceUpdate) {
                displayArea.style.display = 'none';
                displayArea.removeAttribute('data-active-report');
                document.getElementById('codesTableBody').innerHTML = '<tr><td colspan="10">Ø§Ø®ØªØ± Ø¨Ø·Ø§Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„...</td></tr>';
                document.getElementById('reportTitle').textContent = '';
                searchInput.value = ''; 
                
            } else {
                displayArea.style.display = 'block';
                displayArea.setAttribute('data-active-report', reportType);
                document.getElementById('reportTitle').textContent = title;
                searchInput.value = ''; 
                
                renderCodesTable(filteredCodes);
            }
        };

        window.toggleBlockedDevicesArea = () => {
            const reportArea = document.getElementById('reportDisplayArea');
            reportArea.style.display = 'none';
            reportArea.removeAttribute('data-active-report');
            
            const blockedArea = document.getElementById('blockedDevicesArea');
            if (blockedArea.style.display === 'block') {
                blockedArea.style.display = 'none';
            } else {
                blockedArea.style.display = 'block';
                renderBlockedDevicesTable(allBlockedDevices);
            }
        };
        
        window.clearSearchAndTable = () => {
            const activeReport = document.getElementById('reportDisplayArea').getAttribute('data-active-report');
            if (activeReport) {
                toggleReportDisplay(activeReport);
            }
        }
        
        window.filterTable = () => {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (searchTerm.length === 0) {
                renderCodesTable(currentReportCodes);
                return;
            }

            const results = currentReportCodes.filter(data => 
                (data.uid && data.uid.toLowerCase().includes(searchTerm)) || 
                (data.name && data.name.toLowerCase().includes(searchTerm)) ||
                (data.section && data.section.toLowerCase().includes(searchTerm))
            );
            
            renderCodesTable(results);
        };


        // ğŸ’¡ Logic 22: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø´ÙƒÙ„ Ø¬Ù…Ø§Ø¹ÙŠ (General Bulk Update)
        const updateCodesBulk = (uids, dataToUpdate, successMessage) => checkAuthAndProceed(() => {
            if (uids.length === 0) {
                window.showToast("âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø£ÙƒÙˆØ§Ø¯.", "warn");
                return;
            }
            if (!confirm(`Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù„Ù‰ ${uids.length} ÙƒÙˆØ¯ØŸ`)) return;

            const updates = {};
            uids.forEach(uid => {
                updates['approvedStudents/' + uid] = { 
                    ...(allApprovedCodes[uid] || {}),
                    ...dataToUpdate 
                };
            });

            update(ref(db), updates)
                .then(() => {
                    window.showToast(`âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­: ${successMessage} Ø¹Ù„Ù‰ ${uids.length} ÙƒÙˆØ¯.`, "success");
                    window.toggleBulkControls(false); 
                    window.clearSelection();
                })
                .catch(e => window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ: " + e.message, "error"));
        });
        
        // ğŸ’¡ Logic 23: Ø­Ø°Ù Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø´ÙƒÙ„ Ø¬Ù…Ø§Ø¹ÙŠ
        window.deleteCodesBulk = () => checkAuthAndProceed(() => {
            const uids = [...selectedUids];
            if (uids.length === 0) return;
            if (!confirm(`Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${uids.length} ÙƒÙˆØ¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`)) return;
            
            const deletePromises = uids.map(uid => remove(ref(db, 'approvedStudents/' + uid)));
            
            Promise.all(deletePromises)
                .then(() => {
                    window.showToast(`âœ… ØªÙ… Ø­Ø°Ù ${uids.length} ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­.`, "success");
                    window.toggleBulkControls(false);
                    window.clearSelection();
                })
                .catch(e => window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ.", "error"));
        });
        
        // ğŸ’¡ Logic 24: ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø´ÙƒÙ„ Ø¬Ù…Ø§Ø¹ÙŠ
        window.extendCodesBulk = () => checkAuthAndProceed(() => {
             const uids = [...selectedUids];
             if (uids.length === 0) return;
             
             const days = prompt("Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ù„Ù„ØªØ¬Ø¯ÙŠØ¯:");
             const daysInt = parseInt(days);
             if (isNaN(daysInt) || daysInt <= 0) {
                window.showToast("âŒ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… ØµØ­ÙŠØ­.", "warn");
                return;
             }
             
             const dataToUpdate = uids.reduce((updates, uid) => {
                const currentExpiry = allApprovedCodes[uid]?.expiry || Date.now();
                const newExpiry = currentExpiry + (daysInt * 24 * 60 * 60 * 1000);
                // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø§Ù… Ø¹Ø´Ø§Ù† Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                updates[uid] = { 
                    ...(allApprovedCodes[uid] || {}), 
                    expiry: newExpiry 
                };
                return updates;
             }, {});
             
             update(ref(db, 'approvedStudents'), dataToUpdate)
                .then(() => {
                    window.showToast(`âœ… ØªÙ… ØªØ¬Ø¯ÙŠØ¯ ${uids.length} ÙƒÙˆØ¯ Ù„Ù€ ${daysInt} ÙŠÙˆÙ….`, "success");
                    window.toggleBulkControls(false);
                    window.clearSelection();
                })
                .catch(e => window.showToast("âŒ ÙØ´Ù„ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ: " + e.message, "error"));
        });
        
        // ğŸ’¡ Logic 25: ØªØ¹Ø·ÙŠÙ„/ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø´ÙƒÙ„ Ø¬Ù…Ø§Ø¹ÙŠ
        window.toggleBlockBulk = (blockState) => checkAuthAndProceed(() => {
            const uids = [...selectedUids];
            if (uids.length === 0) return;
            
            const stateText = blockState ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„';
            const dataToUpdate = { isBlocked: blockState };
            
            updateCodesBulk(uids, dataToUpdate, stateText);
        });
        
        // ğŸ’¡ Logic 26: Ø­Ø¸Ø± Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø´ÙƒÙ„ Ø¬Ù…Ø§Ø¹ÙŠ
        window.blockDevicesBulk = () => checkAuthAndProceed(() => {
             const uids = [...selectedUids];
             if (uids.length === 0) return;
             
             const devicesToBlock = uids.map(uid => allApprovedCodes[uid]?.deviceId).filter(Boolean);
             if (devicesToBlock.length === 0) {
                 window.showToast("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø© Ù…ÙØ¹Ù‘Ù„Ø© Ù„Ø­Ø¸Ø±Ù‡Ø§ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.", "warn");
                 return;
             }
             if (!confirm(`Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± ${devicesToBlock.length} Ø¬Ù‡Ø§Ø²ØŸ`)) return;

             const blockPromises = devicesToBlock.map(deviceId => 
                set(ref(db, 'blockedDevices/' + deviceId), {
                    deviceId: deviceId,
                    blockedBy: CURRENT_ADMIN_ROLE,
                    blockedAt: Date.now(),
                })
             );

             Promise.all(blockPromises)
                .then(() => {
                    window.showToast(`âœ… ØªÙ… Ø­Ø¸Ø± ${devicesToBlock.length} Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­.`, "success");
                    window.toggleBulkControls(false);
                    window.clearSelection();
                })
                .catch(e => window.showToast("âŒ ÙØ´Ù„ Ø­Ø¸Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ.", "error"));
        });
        
        // ğŸ’¡ Logic 27: ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù€ Selection
        window.toggleCodeSelection = (uid, isChecked) => {
            if (isChecked) {
                selectedUids.add(uid);
            } else {
                selectedUids.delete(uid);
            }
            window.updateBulkControls();
        };

        window.toggleAllSelection = (isChecked, codes) => {
            if (isChecked) {
                codes.forEach(c => selectedUids.add(c.uid));
            } else {
                codes.forEach(c => selectedUids.delete(c.uid));
            }
            // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ Checkboxes ÙÙŠ Ø§Ù„Ù€ DOM
             document.querySelectorAll('#codesTableBody input[type="checkbox"]').forEach(cb => cb.checked = isChecked);
            window.updateBulkControls();
        };

        window.clearSelection = () => {
            selectedUids.clear();
            document.querySelectorAll('#codesTableBody input[type="checkbox"]').forEach(cb => cb.checked = false);
            window.updateBulkControls();
        };

        window.updateBulkControls = () => {
            const count = selectedUids.size;
            const container = document.getElementById('bulkControls');
            document.getElementById('selectedCount').textContent = count;
            
            if (count > 0) {
                container.style.display = 'flex';
            } else {
                container.style.display = 'none';
            }
        };

        window.toggleBulkControls = (show) => {
             const container = document.getElementById('bulkControls');
             if (show === false) {
                 container.style.display = 'none';
             } else {
                 window.updateBulkControls();
             }
        };
        
        // ğŸ’¡ Logic 28: ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ ÙÙˆØ±Ù… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
        window.toggleBulkCodeForm = (show) => {
            const form = document.getElementById('bulkCodeFormContainer');
            if (show) {
                 checkAuthAndProceed(() => {
                    form.style.display = 'block';
                    // Ù…Ù„Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø´Ø¹Ø¨Ø©
                    const select = document.getElementById('bulkCodeForm').bulkSection;
                    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option>';
                    DIVISIONS.forEach(div => {
                         select.innerHTML += `<option value="${div}">${div}</option>`;
                    });
                });
            } else {
                form.style.display = 'none';
            }
        };

        // ğŸ’¡ Logic 29: ØªÙˆÙ„ÙŠØ¯ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© (Bulk Generation)
        window.generateBulkCodes = (e) => checkAuthAndProceed(async () => {
            e.preventDefault();
            const form = e.target;
            const bundleName = form.bundleName.value.trim();
            const count = parseInt(form.codeCount.value);
            const durationType = form.bulkDurationType.value;
            const section = form.bulkSection.value;

            if (!bundleName || isNaN(count) || count <= 0 || count > 500) {
                 window.showToast("âŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø±Ø²Ù…Ø© ÙˆØ§Ù„Ø¹Ø¯Ø¯ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 500).", "error");
                 return;
            }
            if (!section || !durationType) {
                 window.showToast("âŒ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø© ÙˆÙ…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©.", "error");
                 return;
            }
            if (!confirm(`Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆÙ„ÙŠØ¯ ${count} ÙƒÙˆØ¯ Ø¶Ù…Ù† Ø±Ø²Ù…Ø© '${bundleName}'ØŸ`)) return;

            let expiryTimeOffset;
            if (durationType === 'trial') {
                expiryTimeOffset = 1 * 60 * 60 * 1000;
            } else if (durationType === '30days') {
                expiryTimeOffset = 30 * 24 * 60 * 60 * 1000;
            } else {
                window.showToast("âŒ Ù…Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.", "error");
                return;
            }
            
            const updates = {};
            const codesGenerated = [];
            
            for (let i = 1; i <= count; i++) {
                const newCode = generateUniqueCode();
                const studentName = `${bundleName} ${i}`; // Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù‡Ùˆ (Ø§Ø³Ù… Ø§Ù„Ø±Ø²Ù…Ø© + Ø±Ù‚Ù… Ø§Ù„ÙƒÙˆØ¯)
                const expiryTime = Date.now() + expiryTimeOffset;
                
                updates['approvedStudents/' + newCode] = {
                    uid: newCode,
                    name: studentName,
                    section: section,
                    pricePaid: 0,
                    addedByAdmin: CURRENT_ADMIN_ROLE,
                    approvedAt: Date.now(),
                    expiry: expiryTime,
                    deviceId: "",
                    isBlocked: false,
                    isTrial: durationType === 'trial',
                    deviceChangeCount: 0,
                    maxDeviceChanges: 5,
                    deviceHistory: [] 
                };
                codesGenerated.push(newCode);
            }

            await update(ref(db), updates)
                .then(() => {
                    window.showToast(`âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ ÙˆØ¥Ø¶Ø§ÙØ© ${count} ÙƒÙˆØ¯ (Ø±Ø²Ù…Ø© ${bundleName}).`, "success");
                    window.toggleBulkCodeForm(false);
                    form.reset();
                })
                .catch(error => {
                    window.showToast("âŒ ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯: " + error.message, "error");
                });

        }, e);


        // ğŸ’¡ Main Auth State Observer - ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ

        onAuthStateChanged(auth, (user) => {
            const loginContainer = document.getElementById('loginContainer');
            const mainContent = document.getElementById('mainContent');
            const logoutBtn = document.getElementById('logoutBtn');
            const addCodeBtn = document.getElementById('addCodeButton');
            const bulkCodeBtn = document.getElementById('bulkCodeButton'); // ğŸ’¡ Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
            
            if (user) {
                currentUserUid = user.uid;
                
                checkAdminStatus(user.uid).then(isVerified => {
                    if (isVerified) {
                        loginContainer.style.display = 'none';
                        mainContent.style.display = 'block';
                        addCodeBtn.style.display = 'block';
                        bulkCodeBtn.style.display = 'block'; // ğŸ’¡ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø±
                        logoutBtn.style.display = 'block';
                        loadSaraCodes(); 
                    } else {
                        signOut(auth); 
                    }
                });
            } else {
                currentUserUid = null;
                loginContainer.style.display = 'block';
                mainContent.style.display = 'none';
                addCodeBtn.style.display = 'none';
                bulkCodeBtn.style.display = 'none'; // ğŸ’¡ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø±
                logoutBtn.style.display = 'none';
            }
        });

        // ğŸ’¡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø¹Ø±Ø¶
        
        function formatExpiry(timestamp) {
            const now = Date.now();
            if (timestamp < now) return '<span style="color:red; font-weight:bold;">Ù…Ù†ØªÙ‡ÙŠ</span>';
            const diff = timestamp - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            return `${days}ÙŠ ${hours}Ø³`;
        }
        
        // ğŸ’¡ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ (Ù…ÙØ­Ø¯Ù‘ÙØ« Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ù€ Checkbox)
        function renderCodesTable(codes) {
            const tbody = document.getElementById('codesTableBody');
            tbody.innerHTML = '';
            
            if (codes.length === 0) {
                 const title = document.getElementById('reportDisplayArea').getAttribute('data-active-report');
                 const message = (title) ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.' : 'Ø§Ø®ØªØ± Ø¨Ø·Ø§Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„...';
                 tbody.innerHTML = `<tr><td colspan="10">${message}</td></tr>`;
                return;
            }

            // ğŸ’¡ ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙƒÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø­Ø¯Ø¯Ø© Ø£Ù… Ù„Ø§ Ù„ØªØ­Ø¯ÙŠØ« Ø²Ø± "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„"
            const allChecked = codes.every(c => selectedUids.has(c.uid));
            document.getElementById('checkAllCodes').checked = allChecked;
            document.getElementById('checkAllCodes').onchange = (e) => toggleAllSelection(e.target.checked, codes);

            codes.forEach(data => {
                const isExpired = data.expiry < Date.now();
                const isBlocked = data.isBlocked === true;
                const currentDeviceId = data.deviceId; 
                
                let blockDeviceBtn = '';
                if (currentDeviceId) {
                    const isDeviceGloballyBlocked = isDeviceBlocked(currentDeviceId);
                    
                    if (isDeviceGloballyBlocked) {
                        blockDeviceBtn = `<button onclick="unblockDevice('${currentDeviceId}')" class="unblock-btn" title="Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² ${currentDeviceId}">Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø²</button>`;
                    } else {
                        blockDeviceBtn = `<button onclick="blockDevice('${currentDeviceId}')" class="delete-btn" title="Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² ${currentDeviceId}">Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø²</button>`;
                    }
                } else {
                    blockDeviceBtn = '';
                }

                let statusText;
                let statusClass;

                if (isExpired) {
                    statusText = 'Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©';
                    statusClass = 'status-expired';
                } else if (isBlocked) {
                    statusText = 'Ù…ÙØ¹Ø·Ù‘Ù„ ÙŠØ¯ÙˆÙŠÙ‹Ø§';
                    statusClass = 'status-blocked';
                } else {
                    statusText = 'Ù†Ø´Ø·';
                    statusClass = 'status-active';
                }
                
                const blockBtnText = isBlocked ? 'ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ø·ÙŠÙ„';
                const ejectDisabled = !data.deviceId || isExpired || isBlocked ? 'disabled' : '';
                const ejectTitle = !data.deviceId ? 'Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙØ¹Ù„' : (isExpired || isBlocked ? 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù†Ø´Ø·' : '');

                // ğŸ’¡ Ø¹Ø±Ø¶ Ù…Ø±Ø§Øª Ø§Ù„ØªØºÙŠÙŠØ± ÙˆØ§Ù„Ø³Ø¬Ù„
                const changeCount = data.deviceChangeCount || 0;
                const maxChanges = data.maxDeviceChanges || 5;
                const historyCount = data.deviceHistory?.length || 0;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" onchange="toggleCodeSelection('${data.uid}', this.checked)" ${selectedUids.has(data.uid) ? 'checked' : ''}></td>
                    <td class="code-uid">${data.uid}</td>
                    <td>${data.name}</td>
                    <td>${data.section || 'N/A'}</td> 
                    <td>${data.pricePaid} Ø¬.Ù…</td>
                    <td>${formatExpiry(data.expiry)}</td>
                    <td class="device-id">
                        ${data.deviceId || 'ØºÙŠØ± Ù…ÙÙØ¹Ù„'}
                        <button onclick="copyDeviceId('${data.deviceId}')" class="copy-btn" title="Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø²" ${!data.deviceId ? 'disabled' : ''}>ğŸ“‹</button>
                    </td>
                    <td>${changeCount} / ${maxChanges} (${historyCount} Ø³Ø¬Ù„)</td> 
                    <td class="${statusClass}">${statusText}</td>
                    <td class="actions">
                        <button onclick="openEditModal('${data.uid}', '${data.name}', '${data.section || ''}')" class="edit-btn" title="ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨">ØªØ¹Ø¯ÙŠÙ„</button>
                        ${blockDeviceBtn} 
                        <button onclick="ejectDevice('${data.uid}', '${data.name}')" class="eject-btn" ${ejectDisabled} title="${ejectTitle}">Ø¥Ø®Ø±Ø§Ø¬</button>
                        <button onclick="toggleBlock('${data.uid}', '${data.name}', ${isBlocked})" class="${isBlocked ? 'unblock-btn' : 'block-btn'}">${blockBtnText}</button>
                        <button onclick="deleteCode('${data.uid}', '${data.name}')" class="delete-btn">Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            window.updateBulkControls(); // ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø±Ø¶
        }
        
        // ğŸ’¡ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
        window.renderBlockedDevicesTable = (devices) => {
             const tbody = document.getElementById('blockedDevicesTableBody');
             tbody.innerHTML = '';
             if (devices.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø© Ù…Ø­Ø¸ÙˆØ±Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.</td></tr>`; 
                 return;
             }
             devices.forEach(device => {
                 const date = new Date(device.blockedAt).toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' });
                 
                 const relatedCodes = allSaraCodes.filter(c => c.deviceId === device.deviceId);
                 const codeLinks = relatedCodes.map(c => 
                     `<span class="code-uid">${c.uid} (${c.name})</span>`
                 ).join('<br>');
                 
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                    <td class="code-uid">${device.deviceId}</td>
                    <td>${device.blockedBy}</td>
                    <td>${date}</td>
                    <td>${codeLinks || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯ Ù…ÙØ¹Ù„'}</td> 
                    <td class="actions">
                        <button onclick="unblockDevice('${device.deviceId}')" class="unblock-btn">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±</button>
                    </td>
                 `;
                 tbody.appendChild(tr);
             });
        }
        
        // ğŸ’¡ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (renderStats, toggleStats, toggleAddCodeForm) ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ

        window.renderStats = (totalCodes, totalAmount) => {
             const statsContainer = document.getElementById('statsContainer');
             statsContainer.innerHTML = `
                <div class="stat-item">
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø¶Ø§ÙØ©</p>
                    <strong id="statTotalCodes">${totalCodes}</strong>
                </div>
                <div class="stat-item">
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ‘Ù„</p>
                    <strong id="statTotalAmount" style="color:var(--secondary);">${totalAmount.toLocaleString()} Ø¬.Ù…</strong>
                </div>
            `;
        };
        
        window.toggleStats = (show) => {
            const stats = document.getElementById('statsContainer');
            const statsBtn = document.getElementById('statsButton');
            
            if (show) {
                stats.style.display = 'flex';
                statsBtn.textContent = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ğŸ“‰';
                statsBtn.onclick = () => toggleStats(false);
            } else {
                stats.style.display = 'none';
                statsBtn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ğŸ“ˆ';
                statsBtn.onclick = () => toggleStats(true);
            }
        };

        window.toggleAddCodeForm = (show) => {
            const form = document.getElementById('addCodeFormContainer');
            if (show) {
                 checkAuthAndProceed(() => {
                    // ğŸ’¡ Ø¥Ø®ÙØ§Ø¡ ÙÙˆØ±Ù… Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ø¹Ù†Ø¯ ÙØªØ­ ÙÙˆØ±Ù… Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ§Ø­Ø¯
                    document.getElementById('bulkCodeFormContainer').style.display = 'none'; 
                    form.style.display = 'block';
                    document.getElementById('newCodeDisplay').textContent = generateUniqueCode();
                    
                    const select = document.getElementById('addCodeForm').studentSection;
                    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option>';
                    DIVISIONS.forEach(div => {
                         select.innerHTML += `<option value="${div}">${div}</option>`;
                    });
                });
            } else {
                form.style.display = 'none';
            }
        };


    </script>
    <style>
        :root {
            --bg-dark: #111;
            --primary: #00FF00; /* Cyber Green */
            --secondary: #00E8C8; 
            --text-light: #F0F0F0;
            --error: #FF4444;
            --warn: #FFA500;
            --bg-mid: #222;
            --hover-dark: #333;
            --expired-color: #f7a048; 
            --bulk-bg: #301e00; /* Ù„ÙˆÙ† Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù€ Bulk Controls */
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg-dark); color: var(--text-light); margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 30px auto; padding: 20px; }
        h1 { color: var(--primary); text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--bg-mid); padding-bottom: 10px; }
        
        /* Login Style */
        #loginContainer { background: var(--bg-mid); padding: 30px; border-radius: 10px; max-width: 400px; margin: 100px auto; }
        #loginContainer h2 { color: var(--secondary); text-align: center; margin-bottom: 20px; }
        #loginContainer input, #loginContainer select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #444; border-radius: 5px; background: #333; color: var(--text-light); }
        #loginContainer button { width: 100%; padding: 10px; background: var(--primary); color: var(--bg-dark); border: none; border-radius: 5px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        #loginContainer button:hover { background: #00cc00; }
        
        /* Main Content Style */
        #mainContent { display: none; }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #logoutBtn { background: var(--error); color: var(--text-light); padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: 700; }
        #logoutBtn:hover { background: #cc3333; }
        
        /* Stats & Buttons */
        .controls-row { display: flex; justify-content: space-between; gap: 15px; margin-bottom: 20px; }
        #addCodeButton, #statsButton, #blockedDevicesButton, #bulkCodeButton {
            background: var(--primary); color: var(--bg-dark); padding: 10px 20px; 
            border: none; border-radius: 8px; font-weight: 700; cursor: pointer; 
            transition: 0.3s;
        }
        #addCodeButton:hover, #statsButton:hover, #blockedDevicesButton:hover, #bulkCodeButton:hover { background: #00cc00; }
        #statsButton { background: var(--secondary); }
        #blockedDevicesButton { background: var(--warn); color: var(--bg-dark); } 
        #bulkCodeButton { background: #0099cc; color: var(--text-light); } /* ğŸ’¡ Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© */

        #statsContainer { 
            display: none; 
            justify-content: space-around; 
            background: #1a1a1a; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 25px; 
            border-left: 5px solid var(--primary);
        }
        .stat-item { text-align: center; color: var(--text-light); }
        .stat-item p { margin: 5px 0; font-size: 14px; color: var(--secondary); }
        .stat-item strong { display: block; font-size: 32px; color: var(--primary); }
        
        /* Report Cards Container */
        .report-cards-container {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 25px;
        }
        .report-card {
            flex: 1;
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-top: 5px solid transparent;
        }
        .report-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        .report-card p {
            margin: 5px 0;
            font-size: 14px;
            color: var(--text-light);
        }
        .report-card strong {
            display: block;
            font-size: 30px;
            font-weight: 700;
        }
        #cardActive { border-top-color: var(--primary); }
        #cardBlocked { border-top-color: var(--warn); }
        #cardExpired { border-top-color: var(--error); }
        #cardActive strong { color: var(--primary); }
        #cardBlocked strong { color: var(--warn); }
        #cardExpired strong { color: var(--error); }

        /* Search Container */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        #searchInput {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #333;
            color: var(--text-light);
        }
        .search-container button {
            background: #444;
            color: var(--text-light);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Table Style */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border: 1px solid #444; text-align: right; font-size: 14px; }
        th { background: #333; color: var(--primary); }
        tr:nth-child(even) { background: #1a1a1a; }
        .code-uid, .device-id { font-family: monospace; font-size: 12px; direction: ltr; text-align: left; color: var(--secondary); }

        /* Actions */
        .status-active { color: var(--primary); font-weight: 700; }
        .status-blocked { color: var(--warn); font-weight: 700; }
        .status-expired { color: var(--error); font-weight: 700; } 
        .actions button {
            padding: 5px 8px; border: none; border-radius: 5px; cursor: pointer; margin: 2px; font-weight: 700; transition: 0.2s; font-size: 12px;
        }
        .actions button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .edit-btn { background: #006699; color: var(--text-light); } 
        .copy-btn { background: #444; color: var(--secondary); margin-left: 5px; } 
        .eject-btn { background: #0099cc; color: var(--text-light); }
        .block-btn { background: var(--warn); color: var(--bg-dark); }
        .unblock-btn { background: var(--primary); color: var(--bg-dark); }
        .delete-btn { background: var(--error); color: var(--text-light); }

        /* Add Code Form */
        #addCodeFormContainer, #bulkCodeFormContainer {
            display: none; background: #0a0a0a; padding: 25px; border-radius: 10px; margin-top: 20px;
            border: 2px solid var(--secondary); max-width: 500px; margin-left: auto; margin-right: auto;
        }
        #newCodeDisplay { font-family: monospace; font-size: 18px; color: var(--primary); font-weight: 700; direction: ltr; text-align: left; background: #111; padding: 5px; border-radius: 5px; }
        #addCodeFormContainer input, #addCodeFormContainer select, #bulkCodeFormContainer input, #bulkCodeFormContainer select {
            width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #444; border-radius: 5px; background: #333; color: var(--text-light);
            margin-bottom: 10px;
        }
        
        /* Edit Modal Style */
        .modal {
            display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--bg-mid); margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 10px;
        }
        .modal-content label { display: block; margin-top: 10px; color: var(--secondary); }
        .modal-content input, .modal-content select { width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 10px; border-radius: 4px; background: #333; color: var(--text-light); border: 1px solid #444; }
        .modal-buttons button { padding: 8px 15px; border-radius: 5px; margin-top: 10px; cursor: pointer; font-weight: 700; }
        
        /* Blocked Devices Area Style */
        #blockedDevicesArea {
            display: none; margin-top: 20px; background: #1a1a1a; padding: 20px; border-radius: 10px; border: 2px solid var(--error);
        }
        #blockedDevicesArea h2 { color: var(--error); border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; }
        #blockNewDeviceBtn { background: var(--error); color: var(--text-light); margin-bottom: 15px; }

        /* ğŸ’¡ Bulk Controls Style */
        #bulkControls {
             background: var(--bulk-bg);
             border-left: 5px solid var(--warn) !important;
             display: flex;
             justify-content: space-between;
             align-items: center;
        }
        .bulk-actions-buttons button {
             padding: 8px 12px;
             border-radius: 5px;
             font-size: 13px;
             font-weight: 700;
             margin-left: 5px;
        }
        .bulk-extend-btn { background: #008080; color: var(--text-light); }
        .bulk-block-btn { background: var(--warn); color: var(--bg-dark); }
        .bulk-unblock-btn { background: var(--primary); color: var(--bg-dark); }
        .bulk-device-block-btn { background: var(--error); color: var(--text-light); }
        .bulk-delete-btn { background: #8B0000; color: var(--text-light); }
        .bulk-cancel-btn { background: #555; color: var(--text-light); }
        
        /* Toast */
        #toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 10000; }
        .toast { padding: 12px 20px; border-radius: 10px; margin-top: 10px; font-weight: 700; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); opacity: 0; animation: toastIn 0.5s forwards; transition: opacity 0.5s, transform 0.5s; min-width: 200px; text-align: right; }
        .toast-success { background: var(--primary); color: var(--bg-dark); }
        .toast-error { background: var(--error); color: var(--text-light); }
        .toast-warn { background: var(--warn); color: var(--bg-dark); }

    </style>
</head>
<body>

<div class="container">
    
    <div id="loginContainer">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù (AHMED)</h2>
        <form id="loginForm" onsubmit="handleLogin(event)">
            <input type="email" id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
            <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
            <button type="submit">Ø¯Ø®ÙˆÙ„ ğŸ›¡ï¸</button>
        </form>
    </div>

    <div id="mainContent">
        <div class="header-controls">
            <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ahmed ğŸ’»</h1>
            <button id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
        
        <div class="controls-row">
            <button id="addCodeButton" onclick="toggleAddCodeForm(true)">+ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ ÙØ±Ø¯ÙŠ</button>
            <button id="bulkCodeButton" onclick="toggleBulkCodeForm(true)">+ Ø¥Ø¶Ø§ÙØ© Ø£ÙƒÙˆØ§Ø¯ Ù…ØªØ¹Ø¯Ø¯Ø© (Ø±Ø²Ù…Ø©)</button>
            <button id="blockedDevicesButton" onclick="toggleBlockedDevicesArea()">Ù‚Ø³Ù… Ø­Ø¸Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ğŸš«</button>
            <button id="statsButton" onclick="toggleStats(true)">Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ğŸ“ˆ</button>
        </div>
        
        <div id="statsContainer"></div>
        
        <div id="reportCardsContainer" class="report-cards-container">
            <div class="report-card" id="cardActive" onclick="toggleReportDisplay('active')">
                <p>Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙØ¹Ù‘Ù„Ø©</p>
                <strong id="statActiveCount">0</strong>
            </div>
            <div class="report-card" id="cardBlocked" onclick="toggleReportDisplay('blocked')">
                <p>Ø§Ù„Ù…Ø¹Ø·Ù‘Ù„Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§</p>
                <strong id="statBlockedCount">0</strong>
            </div>
            <div class="report-card" id="cardExpired" onclick="toggleReportDisplay('expired')">
                <p>Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</p>
                <strong id="statExpiredCount">0</strong>
            </div>
        </div>
        
        <div id="addCodeFormContainer">
            <h3>Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ Ø¨ÙˆØ§Ø³Ø·Ø© Ahmed</h3>
            <p>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø§Ù„Ù…ÙÙˆÙ„Ù‘ÙØ¯: <span id="newCodeDisplay">...</span></p>
            <form id="addCodeForm" onsubmit="addNewCode(event)">
                <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                <input type="text" name="studentName" required>
                
                <label>Ø´Ø¹Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                <select name="studentSection" required>
                    </select>

                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø¬Ù†ÙŠÙ‡):</label>
                <input type="number" name="price" min="0" value="0">

                <label>Ù…Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„:</label>
                <select name="durationType" required>
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø©</option>
                    <option value="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ (Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©)</option>
                    <option value="30days">Ø§Ø´ØªØ±Ø§Ùƒ 30 ÙŠÙˆÙ…</option>
                </select>
                
                <div class="form-actions" style="margin-top:10px;">
                    <button type="submit" class="add-code-btn" style="background:var(--primary);">Ø­ÙØ¸ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯</button>
                    <button type="button" class="delete-btn" onclick="toggleAddCodeForm(false)">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
        
        <div id="bulkCodeFormContainer">
            <h3>ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯ Ù…ØªØªØ§Ù„ÙŠØ© (Ø±Ø²Ù…Ø©)</h3>
            <form id="bulkCodeForm" onsubmit="generateBulkCodes(event)">
                <label>Ø§Ø³Ù… Ø§Ù„Ø±Ø²Ù…Ø© (ÙŠØ¸Ù‡Ø± ÙƒØ§Ø³Ù… Ù„Ù„Ø·Ø§Ù„Ø¨):</label>
                <input type="text" name="bundleName" required placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø±Ø²Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰">
                
                <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</label>
                <input type="number" name="codeCount" min="1" max="500" value="20" required>
                
                <label>Ø´Ø¹Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ø±Ø²Ù…Ø©):</label>
                <select name="bulkSection" required>
                    </select>

                <label>Ù…Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„:</label>
                <select name="bulkDurationType" required>
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø©</option>
                    <option value="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ (Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©)</option>
                    <option value="30days">Ø§Ø´ØªØ±Ø§Ùƒ 30 ÙŠÙˆÙ…</option>
                </select>
                
                <div class="form-actions" style="margin-top:10px;">
                    <button type="submit" class="add-code-btn" style="background:var(--primary);">ØªÙˆÙ„ÙŠØ¯ ÙˆØ­ÙØ¸ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</button>
                    <button type="button" class="delete-btn" onclick="toggleBulkCodeForm(false)">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>

        
        <div id="blockedDevicesArea">
            <h2>Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© ğŸš«</h2>
            <button id="blockNewDeviceBtn" onclick="blockNewDevice()">+ Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯ (UID)</button>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø­Ø¸ÙˆØ± (UID)</th>
                            <th>Ø¨ÙˆØ§Ø³Ø·Ø©</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¸Ø±</th>
                            <th>Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙØ¹Ù‘Ù„Ø©</th> 
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="blockedDevicesTableBody">
                        <tr><td colspan="5">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr> 
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="bulkControls" style="display:none; background:var(--bulk-bg); padding:15px; border-radius:10px; margin-bottom:20px; border-left: 5px solid var(--warn);">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <span style="font-weight:700; color:var(--warn);">
                    ØªÙ… ØªØ­Ø¯ÙŠØ¯ <span id="selectedCount">0</span> Ø£ÙƒÙˆØ§Ø¯.
                </span>
                <div class="bulk-actions-buttons">
                    <button onclick="extendCodesBulk()" class="bulk-extend-btn">ØªØ¬Ø¯ÙŠØ¯ Ù…Ø¯Ø©</button>
                    <button onclick="toggleBlockBulk(true)" class="bulk-block-btn">ØªØ¹Ø·ÙŠÙ„</button>
                    <button onclick="toggleBlockBulk(false)" class="bulk-unblock-btn">ØªÙØ¹ÙŠÙ„</button>
                    <button onclick="blockDevicesBulk()" class="bulk-device-block-btn">Ø­Ø¸Ø± Ø£Ø¬Ù‡Ø²Ø©</button>
                    <button onclick="deleteCodesBulk()" class="bulk-delete-btn">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
                    <button onclick="clearSelection()" class="bulk-cancel-btn">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
                </div>
            </div>
        </div>
        
        <div id="reportDisplayArea" style="display:none; margin-top: 20px;">
            <h2 id="reportTitle"></h2>
            
            <div class="search-container">
                <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø´Ø¹Ø¨Ø©..." />
                <button onclick="clearSearchAndTable()">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ± âŒ</button>
            </div>

            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="checkAllCodes" title="ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„" onchange="toggleAllSelection(this.checked, currentReportCodes)"></th>
                            <th>Ø§Ù„ÙƒÙˆØ¯ (UID)</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                            <th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th> 
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                            <th>Ø¬Ù‡Ø§Ø² Ø§Ù„ØªÙØ¹ÙŠÙ„</th>
                            <th>Ù…Ø±Ø§Øª Ø§Ù„ØªØºÙŠÙŠØ±/Ø§Ù„Ø³Ø¬Ù„</th> 
                            <th>Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ¯</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="codesTableBody">
                        <tr><td colspan="10">Ø§Ø®ØªØ± Ø¨Ø·Ø§Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„...</td></tr> 
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<div id="editModal" class="modal" onclick="if(event.target.id=='editModal') this.style.display='none'">
    <div class="modal-content">
        <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
        <input type="hidden" id="edit_uid">
        
        <label for="edit_name">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
        <input type="text" id="edit_name" required>
        
        <label for="edit_section">Ø´Ø¹Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
        <select id="edit_section" required>
            </select>
        
        <div class="modal-buttons">
            <button onclick="saveEdit()" style="background:var(--primary);">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            <button onclick="document.getElementById('editModal').style.display='none'" style="background:#444; color:var(--text-light);">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div id="toast-container"></div>
</body>
</html>
